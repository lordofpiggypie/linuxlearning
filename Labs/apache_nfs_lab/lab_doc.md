Lab Goals and RHCSA Concepts Covered
This advanced lab touches several major RHCSA topics, including:

File sharing and permissions (NFS, filesystem ACLs)

Security enforcement (SELinux contexts and policies)

Network management (firewalld rules, port management)

Automation & Scheduling (Cron, scripting)

Service management (systemd services)

Storage management (LVM management, mounting persistent storage)

Remote management (SSH keys, secure remote administration)

Basic Troubleshooting (system logs, journald)

Lab Scenario
You will set up a robust infrastructure simulating a web application environment. Your environment will include:

VM1 (RHEL 9):
Acts as your Web Application Server running Apache (HTTPD). It serves dynamic content generated by a bash script and mounts shared storage from an NFS server. SELinux and firewall rules must be explicitly set up.

VM2 (RHEL 9):
Acts as your NFS Storage Server, providing shared persistent storage. Configured with proper filesystem ACLs and NFS export restrictions.

Host Laptop (Rocky Linux 9):
Hosts your VMs and will manage automated backups of your web application data.

Step-by-step Lab Outline
1. Set up the Lab Environment
Create two new VMs using KVM/libvirt:

VM1: RHEL 9 Web Server (minimal installation)

VM2: RHEL 9 Storage Server (minimal installation)

Configure static IP addresses via NetworkManager CLI (nmcli) on both VMs.

2. Configure NFS Storage Server (VM2)
Install and enable NFS:

bash
Copy
Edit
sudo dnf install -y nfs-utils
sudo systemctl enable --now nfs-server
Create and configure shared directory:

bash
Copy
Edit
sudo mkdir -p /srv/nfs/webdata
sudo chmod 770 /srv/nfs/webdata
sudo chown nobody:nogroup /srv/nfs/webdata
Configure exports in /etc/exports with ACL restrictions:

bash
Copy
Edit
/srv/nfs/webdata  VM1_IP_ADDRESS(rw,sync,no_root_squash)
Reload NFS exports:

bash
Copy
Edit
sudo exportfs -arv
Configure firewall:

bash
Copy
Edit
sudo firewall-cmd --permanent --add-service=nfs
sudo firewall-cmd --permanent --add-service=rpc-bind
sudo firewall-cmd --permanent --add-service=mountd
sudo firewall-cmd --reload
3. Configure Apache Web Server (VM1)
Install Apache:

bash
Copy
Edit
sudo dnf install -y httpd
sudo systemctl enable --now httpd
Configure firewall for Apache:

bash
Copy
Edit
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --reload
Mount NFS share persistently via /etc/fstab:

bash
Copy
Edit
VM2_IP:/srv/nfs/webdata  /var/www/html/shared  nfs  defaults,_netdev  0 0
Mount immediately:

bash
Copy
Edit
sudo mount -a
4. Configure SELinux Policies
Set SELinux contexts correctly for NFS and Apache:

bash
Copy
Edit
sudo semanage fcontext -a -t httpd_sys_content_t '/var/www/html/shared(/.*)?'
sudo restorecon -Rv /var/www/html/shared
Verify SELinux contexts:

bash
Copy
Edit
ls -Z /var/www/html/shared
5. Dynamic Web Content with Bash Script
Create a simple script (status.sh) on VM1 to dynamically show the status of mounted shares:

bash
Copy
Edit
#!/bin/bash
echo "<html><body><h2>NFS Share Status:</h2>"
if mountpoint -q /var/www/html/shared; then
    echo "<p style='color:green;'>Mounted!</p>"
else
    echo "<p style='color:red;'>Not Mounted!</p>"
fi
echo "</body></html>"
Save as /usr/local/bin/status.sh and make executable:

bash
Copy
Edit
sudo chmod +x /usr/local/bin/status.sh
Configure Apache to serve dynamic content:

bash
Copy
Edit
sudo dnf install -y mod_cgi
sudo systemctl restart httpd
Then in /var/www/cgi-bin/status.sh:

bash
Copy
Edit
#!/bin/bash
/usr/local/bin/status.sh
Make executable:

bash
Copy
Edit
sudo chmod +x /var/www/cgi-bin/status.sh
Test via http://vm1_ip/cgi-bin/status.sh.

6. Automated Backups on Host Laptop
Create a bash backup script on Rocky host to automatically backup web data from VM2 NFS share:

bash
Copy
Edit
#!/bin/bash
DATE=$(date +%Y%m%d%H%M)
mkdir -p ~/backups
rsync -avz -e ssh user@VM2_IP:/srv/nfs/webdata ~/backups/webdata_$DATE
Schedule via cron on host laptop:

bash
Copy
Edit
crontab -e
Add:

ruby
Copy
Edit
0 */6 * * * /path/to/backup_script.sh
Set up SSH key-based authentication from laptop to VM2 (no password backups).

7. Storage Management (Extra Credit)
On VM2, set up an additional logical volume (LVM), format it as XFS, and add as additional storage to /srv/nfs/webdata.

bash
Copy
Edit
sudo pvcreate /dev/vdb
sudo vgcreate webvg /dev/vdb
sudo lvcreate -n weblv -L 5G webvg
sudo mkfs.xfs /dev/webvg/weblv
Add to /etc/fstab and mount:

bash
Copy
Edit
/dev/webvg/weblv /srv/nfs/webdata xfs defaults 0 0
Resize storage dynamically (grow filesystem without downtime).

8. Systemd Services and Troubleshooting
Create a custom systemd service on VM1 (checkmount.service) to monitor NFS mounts:

ini
Copy
Edit
[Unit]
Description=Check NFS Mount

[Service]
Type=simple
ExecStart=/usr/bin/mountpoint /var/www/html/shared
Restart=on-failure

[Install]
WantedBy=multi-user.target
Enable and start:

bash
Copy
Edit
sudo systemctl enable --now checkmount.service
Troubleshoot using:

bash
Copy
Edit
sudo journalctl -u checkmount.service
Wrap-up and Documentation
After completing these tasks, document:

SELinux rules and adjustments made.

Firewall configurations.

Backup process and verification.

Troubleshooting steps for common errors.

Conclusion
This lab scenario provides in-depth experience with essential RHCSA skills: storage management, networked file systems, SELinux security, system services, automation, scripting, and troubleshooting. This is precisely the kind of practical, hands-on knowledge you'll need to be fully prepared for the RHCSA and beyond!
